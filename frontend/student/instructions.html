<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Instructions</title>
  <link rel="stylesheet" href="/shared/styles.css">
  <style>
    body { background: var(--bg); min-height: 100vh; }
    .container { max-width: 700px; margin: 0 auto; padding: 30px 20px; }
    .instruction-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eef;
      font-size: 0.95rem;
      display: flex;
      gap: 10px;
    }
    .instruction-list li:last-child { border-bottom: none; }
    .rule-icon { font-size: 1.1rem; flex-shrink: 0; width: 24px; text-align: center; }
    .student-badge {
      background: linear-gradient(135deg, #1a3a6b, #2d5fa8);
      color: white;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .student-badge .avatar {
      width: 46px; height: 46px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.4rem;
      flex-shrink: 0;
    }
    .confirm-check { display: flex; gap: 10px; align-items: flex-start; padding: 14px 0; }
    .confirm-check input { width: 18px; height: 18px; cursor: pointer; margin-top: 2px; flex-shrink: 0; }
    .confirm-check label { font-size: 0.92rem; cursor: pointer; }
    #fullscreen-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 16px;
      font-size: 0.9rem;
      color: #664d03;
    }
  </style>
</head>
<body>

<div class="page-header">
  <div class="logo-icon">ğŸ“‹</div>
  <div>
    <h1 id="exam-title">Online Examination</h1>
    <div class="subtitle">Exam Instructions</div>
  </div>
</div>

<!-- Fullscreen Blocked Popup -->
<div id="fs-blocked-overlay" style="display:none;position:fixed;inset:0;background:rgba(10,20,40,0.85);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
  <div style="background:white;border-radius:18px;padding:36px;max-width:440px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.4);border-top:5px solid #e67e22;">
    <div style="font-size:3rem;margin-bottom:14px">ğŸ–¥ï¸</div>
    <h3 style="color:#1a3a6b;margin-bottom:10px;font-size:1.3rem">Fullscreen Required</h3>
    <p style="color:#6b7a8d;margin-bottom:8px;font-size:0.95rem">Your browser blocked automatic fullscreen. You must allow fullscreen to continue the exam.</p>
    <p style="color:#e67e22;font-weight:600;margin-bottom:20px;font-size:0.9rem">âš  Click the button below and then click "Allow" if your browser asks for permission.</p>
    <button onclick="retryFullscreen()" style="background:#1a3a6b;color:white;border:none;border-radius:10px;padding:13px 30px;font-size:1rem;font-weight:700;cursor:pointer;width:100%;font-family:inherit;">
      ğŸš€ Enable Fullscreen & Start Exam
    </button>
  </div>
</div>

<div class="container">

  <div class="student-badge">
    <div class="avatar">ğŸ‘¤</div>
    <div>
      <div style="font-weight:700;font-size:1.05rem" id="student-name">Student</div>
      <div style="opacity:0.8;font-size:0.88rem" id="student-roll">Roll Number</div>
    </div>
    <div style="margin-left:auto;text-align:right">
      <div style="font-size:1.3rem;font-weight:700" id="exam-duration">30 min</div>
      <div style="opacity:0.8;font-size:0.82rem">Duration</div>
    </div>
  </div>

  <div class="card mb-3">
    <h3 style="margin-bottom:14px;color:#c0392b">âš  Strict Exam Rules â€” Please Read Carefully</h3>
    <ul class="instruction-list" style="list-style:none;padding:0">
      <li><span class="rule-icon">ğŸ–¥</span><span>The exam must be taken in <strong>full-screen mode</strong>. You will be prompted to enable it.</span></li>
      <li><span class="rule-icon">ğŸš«</span><span><strong>Tab switching is prohibited.</strong> First violation: Warning. Second violation: Exam auto-submitted.</span></li>
      <li><span class="rule-icon">ğŸš«</span><span><strong>Exiting full-screen is prohibited.</strong> First violation: Warning. Second violation: Exam auto-submitted.</span></li>
      <li><span class="rule-icon">ğŸ”’</span><span>Right-click, copy, paste, and all keyboard shortcuts (Ctrl+C, Ctrl+V, F12, etc.) are <strong>disabled</strong>.</span></li>
      <li><span class="rule-icon">â±</span><span>The exam will <strong>auto-submit</strong> when the timer expires.</span></li>
      <li><span class="rule-icon">ğŸ”„</span><span><strong>No page refresh</strong> is allowed during the exam.</span></li>
      <li><span class="rule-icon">â¬…</span><span>The <strong>back button</strong> is disabled during the exam.</span></li>
      <li><span class="rule-icon">1ï¸âƒ£</span><span>Only <strong>one attempt</strong> is permitted. Once submitted, you cannot retake the exam.</span></li>
      <li><span class="rule-icon">ğŸ“Š</span><span>Your score and results will <strong>not</strong> be shown. You will see only a confirmation message.</span></li>
    </ul>
  </div>

  <div class="card mb-3" id="custom-instructions" style="display:none">
    <h3 style="margin-bottom:10px">ğŸ“Œ Additional Instructions</h3>
    <p id="instructions-text"></p>
  </div>

  <div id="fullscreen-warning" class="hidden">
    ğŸ“º Click "Start Exam" below to enable full screen mode. The exam will start immediately after.
  </div>

  <div class="card">
    <div class="confirm-check">
      <input type="checkbox" id="confirm-rules">
      <label for="confirm-rules">I have read and understood all the exam rules. I agree to follow them and accept that violations may result in automatic submission of my exam.</label>
    </div>
    <hr class="divider">
    <button class="btn btn-primary btn-full btn-lg" id="start-btn" disabled onclick="startExam()">
      ğŸš€ Start Exam (Enable Full Screen)
    </button>
  </div>
</div>

<script>
  // Guard: must be logged in
  const token = sessionStorage.getItem('examToken');
  const settings = JSON.parse(sessionStorage.getItem('examSettings') || '{}');
  const student = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');

  if (!token) { window.location.href = '/student/login.html'; }

  // Populate page
  document.getElementById('exam-title').textContent = settings.examTitle || 'Online Examination';
  document.getElementById('student-name').textContent = student.fullName || '';
  document.getElementById('student-roll').textContent = 'Roll: ' + (student.rollNumber || '');
  document.getElementById('exam-duration').textContent = (settings.duration || 30) + ' min';

  if (settings.instructions) {
    document.getElementById('custom-instructions').style.display = '';
    document.getElementById('instructions-text').textContent = settings.instructions;
  }

  document.getElementById('fullscreen-warning').classList.remove('hidden');
  document.getElementById('confirm-rules').addEventListener('change', function() {
    document.getElementById('start-btn').disabled = !this.checked;
  });

  // Disable right-click
  document.addEventListener('contextmenu', e => e.preventDefault());

  function isFullscreen() {
    return !!(document.fullscreenElement || document.webkitFullscreenElement ||
              document.mozFullScreenElement || document.msFullscreenElement);
  }

  function goFullscreen() {
    const el = document.documentElement;
    const fsReq = el.requestFullscreen || el.webkitRequestFullscreen ||
                  el.mozRequestFullScreen || el.msRequestFullscreen;
    if (fsReq) {
      return fsReq.call(el);
    }
    return Promise.resolve();
  }

  function startExam() {
    const btn = document.getElementById('start-btn');
    btn.disabled = true;
    btn.textContent = 'â³ Entering Fullscreen...';

    // Try to enter fullscreen
    const fsPromise = goFullscreen();

    if (fsPromise && typeof fsPromise.then === 'function') {
      fsPromise.then(() => {
        // Successfully entered fullscreen
        btn.textContent = 'âœ… Fullscreen Enabled! Loading Exam...';
        setTimeout(() => { window.location.href = '/student/exam.html'; }, 500);
      }).catch(() => {
        // Browser blocked fullscreen â€” show retry popup
        showFsBlockedPopup();
        btn.disabled = false;
        btn.textContent = 'ğŸš€ Start Exam (Enable Full Screen)';
      });
    } else {
      // Old browser â€” proceed anyway
      setTimeout(() => { window.location.href = '/student/exam.html'; }, 300);
    }
  }

  function showFsBlockedPopup() {
    document.getElementById('fs-blocked-overlay').style.display = 'flex';
  }

  function retryFullscreen() {
    document.getElementById('fs-blocked-overlay').style.display = 'none';
    const btn = document.getElementById('start-btn');
    btn.disabled = true;
    btn.textContent = 'â³ Entering Fullscreen...';

    const fsPromise = goFullscreen();
    if (fsPromise && typeof fsPromise.then === 'function') {
      fsPromise.then(() => {
        btn.textContent = 'âœ… Loading Exam...';
        setTimeout(() => { window.location.href = '/student/exam.html'; }, 500);
      }).catch(() => {
        // Still blocked â€” proceed anyway with warning
        window.location.href = '/student/exam.html';
      });
    } else {
      window.location.href = '/student/exam.html';
    }
  }
</script>
</body>
</html>
